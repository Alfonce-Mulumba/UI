<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LendiBot CRM — Taasi Pochi Demo</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root{
    --green: #0fa95a;
    --dark: #123126;
    --muted: #6b7280;
    --card: #ffffff;
    --bg: #f4f7f6;
    --accent: #10b981;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:0}
  body{height:100vh;background:var(--bg);display:flex;gap:18px}
  /* sidebar */
  .sidebar{width:220px;background:#952f2f;color:#fff;padding:18px 12px;display:flex;flex-direction:column;gap:18px}
  .brand{font-size:20px;font-weight:800;letter-spacing:1px}
  .nav{display:flex;flex-direction:column;gap:8px}
  .nav button{background:transparent;color:#fff;border:none;padding:10px;border-radius:8px;text-align:left;cursor:pointer;font-weight:700}
  .nav button.active{background:rgba(255,255,255,0.06)}
  .small-muted{font-size:12px;color:rgba(255,255,255,0.8)}
  /* main container */
  .main{flex:1;display:flex;flex-direction:column;overflow:hidden}
  .topbar{height:68px;background:var(--card);display:flex;align-items:center;justify-content:space-between;padding:10px 18px;border-bottom:1px solid #e8eef0}
  .search{display:flex;gap:8px;align-items:center}
  .search input{width:360px;padding:10px;border-radius:10px;border:1px solid #e6eef0}
  .profile{display:flex;gap:12px;align-items:center}
  .profile .avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--green),#00885a);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  /* workspace */
  .workspace{display:flex;flex:1;gap:18px;padding:18px;align-items:flex-start;overflow:auto}
  /* centre columns */
  .center{flex:2;display:flex;flex-direction:column;gap:14px}
  .cards{display:flex;gap:12px}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.06);flex:1;min-width:0}
  .card h4{color:var(--muted);font-size:13px;margin-bottom:8px}
  .card .big{font-size:20px;font-weight:800;color:var(--dark)}
  .meta{font-size:12px;color:var(--muted);margin-top:8px}
  /* charts area */
  .charts{display:flex;gap:12px}
  .chart-card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(2,6,23,0.05);flex:1;min-width:0}
  /* right chat panel */
  .chatPanel{width:420px;display:flex;flex-direction:column;gap:12px}
  .chatHeader{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06);display:flex;justify-content:space-between;align-items:center}
  .chatWindow{flex:1;background:linear-gradient(180deg,#fbfff9,#f0fff6);border-radius:12px;padding:12px;overflow:auto;box-shadow:inset 0 0 0 1px rgba(14,43,24,0.02)}
  .chatInputWrap{display:flex;gap:8px;padding:8px;background:var(--card);border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.04)}
  .chatInput{flex:1;padding:10px;border-radius:10px;border:1px solid #e6efea}
  .chatBtn{padding:10px 14px;background:var(--green);color:#fff;border:none;border-radius:10px;cursor:pointer}
  /* chat bubble */
  .bubble{display:inline-block;padding:10px 14px;border-radius:18px;margin-bottom:10px;max-width:78%}
  .bot{background:#e6f8ec;color:var(--dark);float:left}
  .user{background:#fff;color:var(--dark);float:right;border:1px solid #e9f3ee}
  .clearfix{clear:both}
  /* typing dots */
  .typing{display:inline-flex;gap:6px;align-items:center;padding:8px 12px;border-radius:12px;background:#eaf9ee}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--green);opacity:0;animation:dotPulse 1.2s infinite}
  .dot:nth-child(2){animation-delay:0.15s}
  .dot:nth-child(3){animation-delay:0.3s}
  @keyframes dotPulse{0%{opacity:0; transform:translateY(0)}40%{opacity:1; transform:translateY(-6px)}80%{opacity:0; transform:translateY(0)}100%{opacity:0}}
  /* small helpers */
  .muted{color:var(--muted);font-size:13px}
  .centered{display:flex;align-items:center;justify-content:center;height:100%}
  /* responsive */
  @media (max-width:1100px){ .chatPanel{display:none} .search input{width:200px} }
</style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">CRM</div>
    <div class="small-muted">LendiBot / Taasi Pochi Demo</div>
    <div class="nav" aria-label="sidebar navigation">
      <button id="navDash" class="active" onclick="selectNav('dash')">Dashboard</button>
      <button id="navCustomers" onclick="selectNav('customers')">Customers</button>
      <button id="navTx" onclick="selectNav('transactions')">Transactions</button>
      <button id="navReports" onclick="selectNav('reports')">Reports</button>
    </div>
    <div style="margin-top:auto;font-size:12px;opacity:.9">Agent: <b>Intern</b></div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="search">
        <input id="searchInput" placeholder="Search customer by name / phone / ID (ex: 0722... or John Doe)" />
        <button onclick="doSearch()" style="padding:10px 12px;border-radius:8px;border:1px solid #e6eef0;background:#fff;cursor:pointer">Search</button>
        <button onclick="randomSearch()" style="padding:10px 12px;border-radius:8px;border:1px solid #e6eef0;background:linear-gradient(90deg,var(--green),#0b8b4d);color:#fff;cursor:pointer;margin-left:8px">Random demo</button>
      </div>
      <div class="profile">
        <div class="avatar">A</div>
        <div style="text-align:right">
          <div style="font-weight:700">Agent Intern</div>
          <div style="font-size:12px;color:var(--muted)">FS — Portfolio Mgmt</div>
        </div>
      </div>
    </div>

    <div class="workspace">
      <!-- CENTER -->
      <section class="center">
        <div class="cards" id="cardsRow">
          <div class="card">
            <h4>GSM Activity (calls)</h4>
            <div class="big" id="gsmCalls">—</div>
            <div class="meta" id="gsmMeta">—</div>
          </div>
          <div class="card">
            <h4>M-PESA Activity (deposits avg)</h4>
            <div class="big" id="mpesaAvg">—</div>
            <div class="meta">Avg monthly received / balance / last tx</div>
          </div>
          <div class="card">
            <h4>Pochi Wallet (avg bal)</h4>
            <div class="big" id="pochiBal">—</div>
            <div class="meta">Wallet age / tx count</div>
          </div>
        </div>

        <div class="charts">
          <div class="chart-card">
            <h4 style="margin-bottom:10px">Monthly Deposits vs Withdrawals</h4>
            <canvas id="depositsChart" height="160"></canvas>
          </div>
          <div class="chart-card">
            <h4 style="margin-bottom:10px">Daily Active Days (last 30)</h4>
            <canvas id="activityChart" height="160"></canvas>
          </div>
        </div>

        <div class="charts">
          <div class="chart-card" style="flex:1.2">
            <h4 style="margin-bottom:10px">Airtime Usage — Last 6 months</h4>
            <canvas id="airtimeChart" height="140"></canvas>
          </div>
          <div class="chart-card" style="width:260px;">
            <h4 style="margin-bottom:10px">Quick Stats</h4>
            <div class="muted">Avg monthly received:</div><div id="qAvgReceived" style="font-weight:800;margin-bottom:8px">—</div>
            <div class="muted">Avg balance:</div><div id="qAvgBalance" style="font-weight:800;margin-bottom:8px">—</div>
            <div class="muted">Txn count (6m):</div><div id="qTxnCount" style="font-weight:800;margin-bottom:8px">—</div>
            <div class="muted">Wallet age (months):</div><div id="qWalletAge" style="font-weight:800">—</div>
          </div>
        </div>
      </section>

      <!-- CHAT PANEL (right) -->
      <aside class="chatPanel" aria-label="LendiBot panel">
        <div class="chatHeader"><div><strong>LendiBot</strong><div style="font-size:12px;color:var(--muted)">Loan query assistant</div></div><div id="botStatus" class="muted">Idle</div></div>

        <div class="chatWindow" id="chatWindow" aria-live="polite">
          <div id="chatStart" class="muted centered">Open a customer (search) to query LendiBot for reasons.</div>
        </div>

        <div class="chatInputWrap">
          <input id="chatInput" class="chatInput" placeholder="Type 0 for 'why limit 0', 1 for tips, etc." />
          <button class="chatBtn" id="chatSend">Send</button>
        </div>
      </aside>
    </div>
  </main>

<script>
/* -------------------------
   Utilities + Demo rules
   ------------------------- */
function rnd(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function fmt(n){ return (n>=1000)? n.toLocaleString() : n.toString(); }
function money(n){ return 'Ksh ' + (Math.round(n)).toLocaleString(); }

/* Rejection rules (the same you specified) */
const RULES = {
  avgReceivedMin: 20000,
  inactivityDaysMax: 14,
  avgBalanceMin: 2000,
  txnCountMin: 180,
  walletAgeMonthsMin: 3
};

/* State */
let currentCustomer = null;

/* -------------------------
   Data generation (demo)
   ------------------------- */
function generateCustomer(seedName){
  // random but deterministic-ish using seed char codes
  const base = seedName ? seedName.split('').reduce((s,c)=>s+c.charCodeAt(0),0) : Date.now();
  // generate values
  const avgReceived = Math.max(500, Math.round((base % 35000) + rnd(-8000,8000)));
  const avgBalance = Math.max(100, Math.round((base % 7000)/1.5 + rnd(-800,800)));
  const inactivity = Math.abs((base % 30) - rnd(0,5));
  const txnCount = Math.max(10, Math.round((base % 400) + rnd(-50,50)));
  const walletAge = Math.max(0, Math.round((base % 24) / 1 + rnd(-2,2)));
  const calls = Math.max(0, Math.round((base % 500) + rnd(-80,80)));
  const lastTxDays = Math.min(30, rnd(0,15));
  // monthly deposits/withdrawals over 12 months
  const months = Array.from({length:12},(_,i)=> Math.round((avgReceived/2) + rnd(-avgReceived/3, avgReceived/2)));
  const withdrawals = months.map(m=>Math.round(m * (0.6 + Math.random()*0.6)));
  // daily activity (30 days) small random
  const dailyActive = Array.from({length:30},()=> rnd(0,1)); // 0 or 1 active
  // airtime last 6 months
  const airtime = Array.from({length:6},()=> Math.round(Math.max(50, Math.random()*200 + (avgBalance/10))));
  return {
    name: seedName || `Demo ${rnd(1,999)}`,
    phone: '07' + String(rnd(10000000,99999999)),
    id: String(rnd(10000000,99999999)),
    avgReceived, avgBalance, inactivity, txnCount, walletAge, calls, lastTxDays,
    months, withdrawals, dailyActive, airtime
  };
}

/* -------------------------
   UI: update cards & charts
   ------------------------- */
let depositsChart=null, activityChart=null, airtimeChart=null;

function updateOverview(c){
  document.getElementById('gsmCalls').textContent = fmt(c.calls) + ' calls';
  document.getElementById('gsmMeta').textContent = `Last transaction: ${c.lastTxDays} days ago`;
  document.getElementById('mpesaAvg').textContent = money(c.avgReceived);
  document.getElementById('pochiBal').textContent = money(c.avgBalance);
  // quick stats
  document.getElementById('qAvgReceived').textContent = money(c.avgReceived);
  document.getElementById('qAvgBalance').textContent = money(c.avgBalance);
  document.getElementById('qTxnCount').textContent = fmt(c.txnCount);
  document.getElementById('qWalletAge').textContent = c.walletAge + ' mo';
}

function buildCharts(c){
  // deposits vs withdrawals (12 months)
  const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const dels = c.months;
  const wds = c.withdrawals;
  if(depositsChart) depositsChart.destroy();
  depositsChart = new Chart(document.getElementById('depositsChart'), {
    type:'bar',
    data:{labels, datasets:[
      {label:'Deposits', data:dels, backgroundColor:'rgba(15,169,90,0.85)'},
      {label:'Withdrawals', data:wds, backgroundColor:'rgba(2,108,60,0.25)'}
    ]},
    options:{plugins:{legend:{position:'top'}},maintainAspectRatio:false}
  });

  // daily active line
  const days = Array.from({length:30},(_,i)=> (30-i).toString());
  const series = c.dailyActive.map(x=> x*1 + Math.round(Math.random()*2));
  if(activityChart) activityChart.destroy();
  activityChart = new Chart(document.getElementById('activityChart'), {
    type:'line',
    data:{labels:days, datasets:[{label:'Active (1=active day)', data:series, borderColor:'rgba(15,169,90,0.95)', backgroundColor:'rgba(15,169,90,0.12)', tension:0.25}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true, max:5}},maintainAspectRatio:false}
  });

  // airtime (6 months)
  const m6 = ['-5m','-4m','-3m','-2m','-1m','Now'];
  if(airtimeChart) airtimeChart.destroy();
  airtimeChart = new Chart(document.getElementById('airtimeChart'), {
    type:'bar',
    data:{labels:m6, datasets:[{label:'Airtime (Ksh)', data:c.airtime, backgroundColor:'rgba(6,170,120,0.9)'}]},
    options:{plugins:{legend:{display:false}},maintainAspectRatio:false}
  });
}

/* -------------------------
   Search / demo flows
   ------------------------- */
function doSearch(){
  const q = document.getElementById('searchInput').value.trim();
  if(!q){
    alert('Type a name (or phone/id) or click Random demo');
    return;
  }
  // for demo we just use q as name
  const c = generateCustomer(q);
  setCustomer(c);
}
function randomSearch(){ setCustomer(generateCustomer('Demo'+rnd(1,9999))); }

function setCustomer(c){
  currentCustomer = c;
  document.getElementById('chatStart')?.remove();
  updateOverview(c);
  buildCharts(c);
  // show greeting in bot window
  const cw = document.getElementById('chatWindow');
  cw.innerHTML = '';
  appendBot(`Viewing: ${c.name} — ${c.phone}\nAvg received: ${money(c.avgReceived)}  •  Avg balance: ${money(c.avgBalance)}`);
  appendBot(`Menu:\n\n0. Why is my limit 0?\n1. How to increase my limit?\n2. Repayment flow\n3. Quick tips\n00. Main menu`);
  document.getElementById('botStatus').textContent = 'Ready';
}

/* -------------------------
   Chat / bot behavior
   ------------------------- */
function appendMessage(text, klass='bot'){
  const el = document.createElement('div');
  el.className = 'bubble ' + (klass==='bot' ? 'bot' : 'user');
  el.textContent = text;
  document.getElementById('chatWindow').appendChild(el);
  const cl = document.createElement('div'); cl.className='clearfix';
  document.getElementById('chatWindow').appendChild(cl);
  document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
}
function appendBot(text){
  appendMessage(text,'bot');
}
function appendUser(text){
  appendMessage(text,'user');
}

/* typing dots element */
function showTypingDots(){
  const wrap = document.createElement('div');
  wrap.className = 'typing bubble bot';
  wrap.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
  document.getElementById('chatWindow').appendChild(wrap);
  document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
  return wrap;
}

/* typed-out message effect */
function typeOut(text, done){
  const container = document.createElement('div');
  container.className = 'bubble bot';
  container.textContent = '';
  document.getElementById('chatWindow').appendChild(container);
  const cl = document.createElement('div'); cl.className='clearfix';
  document.getElementById('chatWindow').appendChild(cl);
  let i=0;
  const speed = 18; // ms per character
  function step(){
    container.textContent = text.slice(0,i);
    document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
    if(i++ < text.length) requestAnimationFrame(()=>setTimeout(step,speed));
    else if(done) done();
  }
  step();
}

/* Bot decision logic: why limit 0 */
function evaluateLimitReason(c){
  const triggered = [];
  if(c.avgReceived < RULES.avgReceivedMin) triggered.push('LowAvgReceived');
  if(c.inactivity > RULES.inactivityDaysMax) triggered.push('InactiveDays');
  if(c.avgBalance < RULES.avgBalanceMin) triggered.push('LowBalance');
  if(c.txnCount < RULES.txnCountMin) triggered.push('FewTxns');
  if(c.walletAge < RULES.walletAgeMonthsMin) triggered.push('NewWallet');
  return triggered;
}

/* friendly reason messages */
function reasonMessage(triggers, c){
  if(triggers.length === 0) return "We don't see an immediate eligibility rule triggered. Consider reviewing internal flags or contacting underwriting for more details.";
  // pick top reason priority order
  const priority = ['LowAvgReceived','InactiveDays','LowBalance','FewTxns','NewWallet'];
  for(const key of priority){
    if(triggers.includes(key)){
      switch(key){
        case 'LowAvgReceived':
          return `Your limit is 0 because your average monthly received amount (Ksh ${fmt(c.avgReceived)}) is below our minimum threshold of Ksh ${fmt(RULES.avgReceivedMin)}. Increasing incoming transaction flow will help.`;
        case 'InactiveDays':
          return `Your limit is 0 because the wallet has been inactive for ${c.inactivity} days. Regular incoming/outgoing activity for 2+ weeks helps build trust.`;
        case 'LowBalance':
          return `Your limit is 0 because the average wallet balance (Ksh ${fmt(c.avgBalance)}) is below our threshold of Ksh ${fmt(RULES.avgBalanceMin)}. Keeping some balance and regular receipts helps.`;
        case 'FewTxns':
          return `Your limit is 0 because transaction count over 6 months (approx ${fmt(c.txnCount)}) is low. Frequent micro-transactions increase your score.`;
        case 'NewWallet':
          return `Your limit is 0 because the wallet is relatively new (${c.walletAge} months). Building transaction history over a few months will qualify you.`;
      }
    }
  }
  return "There are multiple factors impacting eligibility. Keep activity steady and balances healthy.";
}

/* handle incoming chat commands */
document.getElementById('chatSend').addEventListener('click', handleChatInput);
document.getElementById('chatInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleChatInput(); });

function handleChatInput(){
  const v = document.getElementById('chatInput').value.trim();
  if(!v) return;
  appendUser(v);
  document.getElementById('chatInput').value='';
  // interpret commands
  if(!currentCustomer){
    const t = showTypingDots();
    setTimeout(()=>{ t.remove(); typeOut("Open/select a customer first (use search) so I can fetch wallet info.", ()=>{}); },900);
    return;
  }
  // immediate "processing" dot for 700ms
  const t1 = showTypingDots();
  setTimeout(()=>{ t1.remove(); processChatCommand(v); },700);
}

function processChatCommand(command){
  const c = currentCustomer;
  const s = command.trim();
  if(s==='0' || s.toLowerCase().includes('why') || s.toLowerCase().includes('limit 0')){
    // run evaluation sequence with staged spinners & messages to mimic middleware/gateway/db
    document.getElementById('botStatus').textContent = 'Processing';
    const tA = showTypingDots();
    setTimeout(()=>{ tA.remove();
      const step1 = showTypingDots();
      setTimeout(()=>{ step1.remove();
        const step2 = showTypingDots();
        setTimeout(()=>{ step2.remove();
          // compute reasons
          const triggers = evaluateLimitReason(c);
          const msg = reasonMessage(triggers, c);
          // show typed msg
          typeOut(msg, ()=>{ document.getElementById('botStatus').textContent = 'Ready'; });
        }, 1000);
      }, 900);
    }, 800);
    return;
  }
  if(s==='1' || s.toLowerCase().includes('increase')){
    const msg = "To increase your limit: repay on time, keep receiving payments regularly, maintain a healthy average balance, and avoid long inactivity. Offer promotions to your buyers to increase incoming flows.";
    const t = showTypingDots();
    setTimeout(()=>{ t.remove(); typeOut(msg); },800);
    return;
  }
  if(s==='2' || s.toLowerCase().includes('repay')){
    const msg = "Repayment is automatic from Pochi wallet when funds are available. Customers may also repay manually via the Loans menu or M-PESA paybill as advised.";
    const t = showTypingDots();
    setTimeout(()=>{ t.remove(); typeOut(msg); },800);
    return;
  }
  if(s==='3' || s.toLowerCase().includes('tip')){
    const tips = [
      "Tip: Make small regular receipts — frequency matters as much as volume.",
      "Tip: Keep an avg balance above Ksh 2,000 to improve eligibility.",
      "Tip: Avoid inactivity. Even receiving a few small payments weekly helps."
    ];
    const msg = tips[rnd(0,tips.length-1)];
    const t = showTypingDots();
    setTimeout(()=>{ t.remove(); typeOut(msg); },600);
    return;
  }
  // default fallback
  const t = showTypingDots();
  setTimeout(()=>{ t.remove(); typeOut("I can help with: 0=Why limit 0, 1=How to increase, 2=Repayment, 3=Tips"); },700);
}

/* bootstrap: empty charts placeholders */
function initEmptyCharts(){
  depositsChart = new Chart(document.getElementById('depositsChart'), {type:'bar',data:{labels:[],datasets:[]},options:{maintainAspectRatio:false}});
  activityChart = new Chart(document.getElementById('activityChart'), {type:'line',data:{labels:[],datasets:[]},options:{maintainAspectRatio:false}});
  airtimeChart = new Chart(document.getElementById('airtimeChart'), {type:'bar',data:{labels:[],datasets:[]},options:{maintainAspectRatio:false}});
}
initEmptyCharts();

</script>
</body>
</html>
